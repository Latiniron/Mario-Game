<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jet Star Collector</title>
  <style>
    :root {
      --jet-color: #00BFFF;
      --jet-cockpit: #ADD8E6;
      --star-1: #FFFF00;
      --star-2: #FFD700;
      --star-3: #FFC000;
      --hud-bg: rgba(0, 0, 0, 0.65);
      --joystick-base: rgba(255,255,255,0.15);
      --joystick-knob: #eeeeee;
      --bg: #000033;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      font-family: "Courier New", monospace;
      color: #9ff0a8;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Spiel-Container */
    #gameContainer {
      width: min(900px, 92vw);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    /* Spielbereich */
    #gameCanvas {
      width: 100%;
      max-width: 800px;
      height: 450px;
      background: #000033;
      border: 3px solid #333;
      border-radius: 8px;
      image-rendering: pixelated;
      display: block;
    }

    /* HUD (oben) */
    #hud {
      position: relative;
      width: 100%;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: var(--hud-bg);
      border-radius: 6px;
      font-size: 13px;
      color: #9ff0a8;
      box-shadow: 0 2px 6px rgba(0,0,0,.5);
    }

    /* Joystick-Bereich (unten links) */
    #joystick {
      position: absolute;
      left: 12px;
      bottom: 12px;
      width: 120px;
      height: 120px;
      z-index: 2;
    }
    .joystick-base {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--joystick-base);
      border: 2px solid rgba(255,255,255,.6);
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 0;
      top: 0;
    }
    .joystick-knob {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--joystick-knob);
      border: 2px solid #aaa;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 4px 8px rgba(0,0,0,.5);
      touch-action: none;
    }

    /* Overlay Start / End */
    #overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.6);
      z-index: 5;
    }
    #overlay.active { display: flex; }
    #overlayPanel {
      background: rgba(0,0,0,.8);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: #fff;
      min-width: 260px;
      box-shadow: 0 8px 20px rgba(0,0,0,.6);
    }
    #overlayPanel h2 { margin: 0 0 6px 0; }
    #overlayPanel p { margin: 0 0 12px 0; font-size: 13px; }

    .btn {
      padding: 10px 14px;
      border-radius: 6px;
      border: 0;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      margin: 0 6px;
    }
    .btn.primary { background: #4f46e5; color: white; }
    .btn.secondary { background: #374151; color: white; }

    @media (max-width: 700px) {
      #gameCanvas { height: 420px; }
      #hud { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <!-- Overlay: Schwierigkeit auswählen + Start -->
    <div id="overlay" class="overlay" aria-label="Spiel starten Overlay">
      <div id="overlayPanel">
        <h2>Jet Star Collector</h2>
        <p>Wähle eine Schwierigkeit und starte das Spiel.</p>
        <div id="difficulty-select" style="margin: 8px 0;" aria-label="Schwierigkeit auswählen">
          <button class="btn" data-diff="1" aria-label="Leicht">LEICHT</button>
          <button class="btn" data-diff="2" aria-label="Mittel">MITTEL</button>
          <button class="btn" data-diff="3" aria-label="Schwer">SCHWER</button>
        </div>
        <div style="margin-top: 6px;">
          <button id="startBtn" class="btn primary" aria-label="Spiel Starten">Start</button>
          <button id="pauseBtn" class="btn secondary" aria-label="Spiel Beenden">Beenden</button>
        </div>
        <div id="selectedDiff" style="margin-top:8px; font-size:12px;">
          Schwierigkeit: <span id="diffName">MITTEL</span>
        </div>
      </div>
    </div>

    <!-- HUD-Leiste -->
    <div id="hud" aria-label="HUD-Leiste">
      <div>Time: <span id="time">60</span>s</div>
      <div>Score: <span id="score">0</span></div>
      <div>Diff: <span id="diffNameHud">MITTEL</span></div>
    </div>

    <!-- Spielbereich -->
    <canvas id="gameCanvas" width="800" height="450" aria-label="Spielbereich"></canvas>

    <!-- Joystick (unten links) -->
    <div id="joystick" aria-label="Joystick">
      <div class="joystick-base" id="joystickBase"></div>
      <div class="joystick-knob" id="joystickKnob"></div>
    </div>
  </div>

  <script>
    // Spielkonstanten
    const CANVAS_W = 800;
    const CANVAS_H = 450;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = CANVAS_W;
    canvas.height = CANVAS_H;

    // HUD Elemente
    const timeEl = document.getElementById('time');
    const scoreEl = document.getElementById('score');
    const diffHudEl = document.getElementById('diffNameHud');
    const diffNamePanelEl = document.getElementById('diffName');

    // Overlay Buttons
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const diffButtons = Array.from(document.querySelectorAll('[data-diff]'));

    // Farbe & Objekte
    const JET_W = 40;
    const JET_H = 28;
    const JET_Y_OFFSET = 18;
    const jet = { x: CANVAS_W/2 - JET_W/2, y: CANVAS_H - JET_H - JET_Y_OFFSET, vx: 0, vy: 0, w: JET_W, h: JET_H };

    // Joystick-Logik (2D)
    const JOY_RADIUS = 60;
    let joyActive = false;
    let joyX = 0; // -1..1
    let joyY = 0; // -1..1
    let joyCenterX = 0;
    let joyCenterY = 0;
    let joyPointerId = null;
    const joyBase = document.getElementById('joystickBase');
    const joyKnob = document.getElementById('joystickKnob');

    // Stars (Sterne)
    const STAR_R = 10;
    let stars = [];
    let spawnTimer = 0;
    let spawnInterval = 0.8; // Sekunden
    let score = 0;
    let timeLeft = 60; // Sekunden
    let lastTime = 0;
    let running = false;
    let requestId = null;

    // Difficulty
    let currentDiff = 2; // 1 Leicht, 2 Mittel, 3 Schwer
    const diffNames = {1: 'LEICHT', 2: 'MITTEL', 3: 'SCHWER'};

    // Init Joystick Center
    function updateJoyCenter() {
      const rect = joyBase.getBoundingClientRect();
      // Center innerhalb des Joysticks im Viewport
      joyCenterX = rect.left + rect.width/2;
      joyCenterY = rect.top + rect.height/2;
    }

    // Collision: Kreiss Stern vs Rechteck Jet
    function circleRectCollision(cx, cy, r, rx, ry, rw, rh) {
      const closestX = Math.max(rx, Math.min(cx, rx + rw));
      const closestY = Math.max(ry, Math.min(cy, ry + rh));
      const dx = cx - closestX;
      const dy = cy - closestY;
      return (dx*dx + dy*dy) <= (r*r);
    }

    // Star spawnen (auf den Jet zu)
    function spawnStar() {
      const x = Math.random() * (CANVAS_W - STAR_R*2) + STAR_R;
      // Richtung Jet (leicht nach unten, variiert)
      const targetX = jet.x + jet.w / 2;
      const targetY = jet.y + jet.h / 2;
      const dx = targetX - x;
      const dy = targetY - (-STAR_R);
      const dist = Math.max(1, Math.hypot(dx, dy));
      const baseVy = 60; // Grundgeschwindigkeit
      const vy = baseVy * (1 + (currentDiff - 1) * 0.6);
      const vx = (dx / dist) * vy * 0.6; // leichte Abweichung
      const colors = ['#FFFF00', '#FFD700', '#FFC000'];
      const color = colors[Math.floor(Math.random()*colors.length)];
      stars.push({ x, y: -STAR_R, r: STAR_R * (0.8 + Math.random()*0.4), vx, vy, color });
    }

    // HUD aktualisieren
    function updateHUD() {
      scoreEl.textContent = score;
      timeEl.textContent = Math.ceil(timeLeft);
      diffHudEl.textContent = diffNames[currentDiff];
      diffNamePanelEl.textContent = diffNames[currentDiff];
    }

    // Reset Spielzustand
    function resetGame() {
      stars.length = 0;
      spawnTimer = 0;
      spawnInterval = 0.8;
      jet.x = CANVAS_W/2 - JET_W/2;
      jet.y = CANVAS_H - JET_H - JET_Y_OFFSET;
      jet.vx = 0;
      jet.vy = 0;
      score = 0;
      timeLeft = 60;
    }

    // Start / Pause / End
    function startGame() {
      resetGame();
      updateHUD();
      timeLeft = 60;
      lastTime = performance.now();
      running = true;
      if (requestId) cancelAnimationFrame(requestId);
      requestId = requestAnimationFrame(loop);
      overlay.style.display = 'none';
    }

    function pauseGame() {
      running = false;
      if (requestId) cancelAnimationFrame(requestId);
      overlay.style.display = 'flex';
    }

    function endGame() {
      running = false;
      if (requestId) cancelAnimationFrame(requestId);
      overlay.style.display = 'flex';
      overlay.innerHTML = `
        <div id="overlayPanel">
          <h2>Game Over</h2>
          <p>Dein Score: ${score}</p>
          <div>
            <button class="btn primary" onclick="location.reload()">Neu starten</button>
          </div>
        </div>
      `;
    }

    // Game Loop
    function loop(now) {
      if (!lastTime) lastTime = now;
      const dt = Math.min(0.033, (now - lastTime) / 1000);
      lastTime = now;

      update(dt);
      draw();

      if (running) requestId = requestAnimationFrame(loop);
    }

    // Update Logik
    function update(dt) {
      if (!running) return;

      timeLeft -= dt;
      if (timeLeft <= 0) {
        endGame();
        return;
      }

      // Jet-Bewegung per Joystick (2D)
      const SPEED = 260;
      const targetVX = joyX * SPEED;
      const targetVY = joyY * SPEED;

      jet.vx += (targetVX - jet.vx) * 0.15;
      jet.vy += (targetVY - jet.vy) * 0.15;
      jet.x += jet.vx * dt;
      jet.y += jet.vy * dt;

      // Randbegrenzung
      if (jet.x < 0) jet.x = 0;
      if (jet.x + jet.w > CANVAS_W) jet.x = CANVAS_W - jet.w;
      if (jet.y < 0) jet.y = 0;
      if (jet.y + jet.h > CANVAS_H) jet.y = CANVAS_H - jet.h;

      // Sterne spawnen
      spawnTimer += dt;
      if (spawnTimer >= spawnInterval) {
        spawnStar();
        spawnTimer = 0;
        spawnInterval = Math.max(0.25, 0.8 - (currentDiff - 1) * 0.15);
      }

      // Sterne bewegen & Kollisionsabfragen
      for (let i = stars.length - 1; i >= 0; i--) {
        const s = stars[i];
        s.x += s.vx * dt;
        s.y += s.vy * dt;

        if (circleRectCollision(s.x, s.y, s.r, jet.x, jet.y, jet.w, jet.h)) {
          stars.splice(i, 1);
          score++;
          updateHUD();
          // Optional: maximaler Score könnte End condition sein
        }

        // Entfernen, wenn außerhalb unten
        if (s.y - s.r > CANVAS_H) {
          stars.splice(i, 1);
        }
      }

      // Keyboard-Status (optional Echtzeit-Verbesserung)
      // Keine spezielle Logik nötig, Joystick-Status wird durch Tastatur gesetzt
    }

    function drawJet() {
      ctx.fillStyle = '#00BFFF';
      const x = jet.x;
      const y = jet.y;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + jet.w, y + jet.h/2);
      ctx.lineTo(x, y + jet.h);
      ctx.closePath();
      ctx.fill();

      // Cockpit-Licht
      ctx.fillStyle = '#A8D8FF';
      ctx.fillRect(x + jet.w*0.25, y + jet.h*0.2, jet.w*0.5, jet.h*0.25);
    }

    function drawStars() {
      for (const s of stars) {
        ctx.fillStyle = s.color;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }
    }

    function draw() {
      // Hintergrund
      ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);
      ctx.fillStyle = '#000033';
      ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);

      drawStars();
      drawJet();
    }

    // Joystick-Setup
    function updateJoyCenterOnce() {
      updateJoyCenter();
    }

    function initJoystick() {
      updateJoyCenter();
      window.addEventListener('resize', updateJoyCenter);

      joyBase.style.touchAction = 'none';
      joyBase.addEventListener('pointerdown', (e) => {
        joyPointerId = e.pointerId;
        joyBase.setPointerCapture(joyPointerId);
        const dx = e.clientX - joyCenterX;
        const dy = e.clientY - joyCenterY;
        const dist = Math.hypot(dx, dy) || 1;
        const nx = (dx / dist) * Math.min(dist, JOY_RADIUS);
        const ny = (dy / dist) * Math.min(dist, JOY_RADIUS);
        joyX = nx / JOY_RADIUS;
        joyY = ny / JOY_RADIUS;
        joyKnob.style.transform = `translate(${nx}px, ${ny}px)`;
        joyActive = true;
        e.preventDefault();
      });
      window.addEventListener('pointermove', (e) => {
        if (!joyActive) return;
        const dx = e.clientX - joyCenterX;
        const dy = e.clientY - joyCenterY;
        const dist = Math.hypot(dx, dy) || 1;
        const clamped = Math.min(dist, JOY_RADIUS);
        const nx = (dx / dist) * clamped;
        const ny = (dy / dist) * clamped;
        joyX = nx / JOY_RADIUS;
        joyY = ny / JOY_RADIUS;
        joyKnob.style.transform = `translate(${nx}px, ${ny}px)`;
      });
      window.addEventListener('pointerup', (e) => {
        if (e.pointerId === joyPointerId) {
          joyActive = false;
          joyPointerId = null;
          joyX = 0; joyY = 0;
          joyKnob.style.transform = 'translate(0,0)';
          joyBase.releasePointerCapture(e.pointerId);
        }
      });
    }

    // Difficulty-Auswahl
    function setDifficultyFromBtn(diff) {
      currentDiff = diff;
      diffNamePanelEl.textContent = diffNames[currentDiff];
      diffHudEl.textContent = diffNames[currentDiff];
    }

    // Overlay-Events
    diffButtons.forEach(btn => btn.addEventListener('click', () => {
      setDifficultyFromBtn(parseInt(btn.getAttribute('data-diff'), 10));
    }));
    startBtn.addEventListener('click', startGame);
    pauseBtn.addEventListener('click', pauseGame);

    // Keyboard-Unterstützung (Alternative)
    const keys = { left: false, right: false, up: false, down: false };
    function updateFromKeyboard() {
      // Horizontal Steuerung über Joystick-Äquivalent
      const vx = (keys.left ? -1 : 0) + (keys.right ? 1 : 0);
      const vy = (keys.up ? -1 : 0) + (keys.down ? 1 : 0);
      joyX = vx;
      joyY = vy;
    }
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
      if (e.key === 'ArrowUp' || e.key === 'w') keys.up = true;
      if (e.key === 'ArrowDown' || e.key === 's') keys.down = true;
      updateFromKeyboard();
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
      if (e.key === 'ArrowUp' || e.key === 'w') keys.up = false;
      if (e.key === 'ArrowDown' || e.key === 's') keys.down = false;
      updateFromKeyboard();
    });

    // Init
    window.addEventListener('load', () => {
      // Set default difficulty
      setDifficultyFromBtn(currentDiff);
      diffNamePanelEl.textContent = diffNames[currentDiff];
      diffHudEl.textContent = diffNames[currentDiff];
      // Overlay sichtbar am Anfang
      overlay.style.display = 'flex';
      // Joystick vorbereiten
      initJoystick();
      // Center erfassen
      updateJoyCenter();
      // Startwerte im HUD
      updateHUD();
      // Starte Loop nur nach Klick auf Start
    });

  </script>
</body>
</html>
